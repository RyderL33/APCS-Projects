import java.io.IOException;
import java.util.Scanner;
import java.net.URL;

public class Book
{
    private String book;

    public Book(String url)
    {
        book = ""; // Initialize the book string
        readBook(url);
    }

    public void readBook(String link)
    {
        try
        {
            URL url = new URL(link);
            Scanner s = new Scanner(url.openStream());

            // Using StringBuilder for efficient text accumulation
            StringBuilder translatedBook = new StringBuilder();

            while(s.hasNextLine())
            {
                String text = s.nextLine();
                // Translate the line and append it
                translatedBook.append(translateSentence(text));
                // Add a newline character to maintain the original line breaks
                translatedBook.append("\n"); 
            }
            s.close();
            book = translatedBook.toString(); // Store the final translated text
        }
        catch(IOException ex)
        {
            ex.printStackTrace();
        }
    }

    // New method to retrieve the translated book
    public String getTranslatedBook() {
        return book;
    }

    public String pigLatin(String word)
    {
        if (word == null || word.length() == 0) return word;
        if (word.contains(" ")) return translateSentence(word);
        return translateWord(word);
    }

    public int endPunctuation(String word)
    {
        if (word.matches("^[\\p{Punct}]+$")) return 0;
        for (int i = word.length() - 1; i >= 0; i--) 
        {
            char c = word.charAt(i); 
            if (Character.isLetterOrDigit(c)) 
            {
                if (i == word.length() - 1) return -1;
                else return i + 1;
            }
        }
        return -1;
    }

    public String translateWord(String word)
    {
        // Added check to prevent StringIndexOutOfBoundsException if an empty string somehow reaches here
        if (word.isEmpty()) {
            return word;
        }

        String vowels = "aeiouAEIOU";
        int punctIndex = endPunctuation(word);
        String punctuation = "";

        if (punctIndex > 0) 
        {
            punctuation = word.substring(punctIndex);
            word = word.substring(0, punctIndex);
        } 
        else if (punctIndex == 0) 
        {
            return word;
        }

        boolean isCapital = Character.isUpperCase(word.charAt(0));
        String lower = word.toLowerCase();
        String convertedWord;

        if (vowels.indexOf(lower.charAt(0)) != -1) 
        {
            convertedWord = lower + "yay";
        } 
        else 
        {
            int firstVowel = -1;
            for (int i = 0; i < lower.length(); i++) 
            {
                if (vowels.indexOf(lower.charAt(i)) != -1) 
                {
                    firstVowel = i;
                    break;
                }
            }
            if (firstVowel == -1) 
            {
                convertedWord = lower + "ay";
            } 
            else 
            {
                convertedWord = lower.substring(firstVowel) + lower.substring(0, firstVowel) + "ay";
            }
        }

        if (isCapital)
        {
            convertedWord = Character.toUpperCase(convertedWord.charAt(0)) + convertedWord.substring(1);
        }

        convertedWord += punctuation;
        return convertedWord;
    }

    public String translateSentence(String sentence)
    {
        String[] words = sentence.split(" ");
        StringBuilder retSentence = new StringBuilder(); // Use StringBuilder for efficiency

        for (int i = 0; i < words.length; i++) 
        {
            String word = words[i];
            
            // *** FIX FOR StringIndexOutOfBoundsException ***
            // If the word is empty (due to multiple spaces), just append a space 
            // and continue to the next word.
            if (word.isEmpty()) {
                retSentence.append(" ");
                continue; 
            }
            // ***********************************************
            
            retSentence.append(translateWord(word));
            
            // Only add a space if it's not the last word, OR if the original 
            // sentence ended with a space that created a trailing empty string
            if (i < words.length - 1) 
            {
                retSentence.append(" ");
            }
        }
        return retSentence.toString();
    }
}
